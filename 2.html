<!DOCTYPE html>
<html lang="en" data-theme="default" data-mode="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <style>
        :root {
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-techy: 'Courier New', Courier, monospace;
        }

        /* --- Theme Engine: CSS Variables --- */
        [data-theme="default"][data-mode="dark"] {
            --bg-color: #121212; --surface-color: #1e1e1e; --primary-color: #bb86fc;
            --primary-variant-color: #3700b3; --secondary-color: #03dac6; --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0; --border-color: #333; --error-color: #cf6679;
            --font-family: var(--font-main);
        }
        [data-theme="default"][data-mode="light"] {
            --bg-color: #f5f5f5; --surface-color: #ffffff; --primary-color: #6200ee;
            --primary-variant-color: #e0d2ff; --secondary-color: #018786; --text-color: #121212;
            --text-secondary-color: #555; --border-color: #ddd; --error-color: #b00020;
            --font-family: var(--font-main);
        }
        [data-theme="cozy"][data-mode="dark"] {
            --bg-color: #1a1a1d; --surface-color: #25282c; --primary-color: #ff8c69;
            --primary-variant-color: #4a271d; --secondary-color: #6a9fb5; --text-color: #dcdcdc;
            --text-secondary-color: #9a9a9a; --border-color: #3a3f44; --error-color: #e06c75;
            --font-family: 'Georgia', serif;
        }
        [data-theme="cozy"][data-mode="light"] {
            --bg-color: #fdf6e3; --surface-color: #fbfbfb; --primary-color: #d33682;
            --primary-variant-color: #fae3ef; --secondary-color: #2aa198; --text-color: #333;
            --text-secondary-color: #657b83; --border-color: #eee8d5; --error-color: #dc322f;
            --font-family: 'Georgia', serif;
        }
        [data-theme="techy"][data-mode="dark"] {
            --bg-color: #000000; --surface-color: #0a0a0a; --primary-color: #00ff41;
            --primary-variant-color: #003b00; --secondary-color: #00ffff; --text-color: #00ff41;
            --text-secondary-color: #00b82b; --border-color: #005010; --error-color: #ff0041;
            --font-family: var(--font-techy);
        }
        [data-theme="techy"][data-mode="light"] {
            --bg-color: #e0e0e0; --surface-color: #f0f0f0; --primary-color: #005cc5;
            --primary-variant-color: #cfe2ff; --secondary-color: #d73a49; --text-color: #1b1f23;
            --text-secondary-color: #586069; --border-color: #ccc; --error-color: #d73a49;
            --font-family: var(--font-techy);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%; font-family: var(--font-family); background-color: var(--bg-color);
            color: var(--text-color); font-size: 16px; transition: background-color 0.3s, color 0.3s;
        }
        #app-container { display: flex; height: 100vh; overflow: hidden; flex-direction: column; }
        
        /* --- Sidebar --- */
        #sidebar { background-color: var(--surface-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; width: 100%; height: 40%; transition: transform 0.3s ease-in-out; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        #new-chat-btn { width: 100%; padding: 0.75rem; background-color: var(--primary-color); color: var(--bg-color); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        #new-chat-btn:hover { background-color: var(--secondary-color); }
        #history-list { flex-grow: 1; overflow-y: auto; padding: 0.5rem 0; }
        .history-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; border-left: 3px solid transparent; }
        .history-item:hover { background-color: rgba(255,255,255,0.05); }
        .history-item.active { background-color: rgba(0,0,0,0.1); border-left-color: var(--primary-color); }
        .history-title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; }
        .delete-chat-btn { background: none; border: none; color: var(--text-secondary-color); font-size: 1.2rem; cursor: pointer; opacity: 0; transition: opacity 0.2s; padding: 0 0.5rem; }
        .history-item:hover .delete-chat-btn { opacity: 1; }

        /* --- Main Chat Area --- */
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; height: 60%; }
        .chat-header { position: relative; padding: 0.75rem 1rem; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        #settings-toggle { background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 1.5rem; z-index: 101; }
        #settings-panel { display: none; position: absolute; top: calc(100% + 5px); right: 10px; background-color: #2a2a2a; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5); width: 300px; }
        #settings-panel.settings-visible { display: block; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .setting { display: flex; flex-direction: column; }
        .setting label, .theme-setting label { font-size: 0.8rem; margin-bottom: 0.25rem; color: var(--text-secondary-color); }
        .setting input[type="range"], .setting input[type="number"], .theme-setting select { width: 100%; background: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 4px; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .message { position: relative; max-width: 85%; padding: 0.75rem 1rem; border-radius: 12px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .message.user { background-color: var(--primary-variant-color); align-self: flex-end; border-bottom-right-radius: 2px; }
        .message.model { background-color: var(--surface-color); align-self: flex-start; border-bottom-left-radius: 2px; }
        .message.error { background-color: var(--error-color); color: #000; align-self: center; }
        .message.loading { color: var(--text-secondary-color); align-self: flex-start; }
        .message-actions { position: absolute; bottom: 5px; right: -5px; display: none; gap: 5px; background: var(--bg-color); padding: 2px 5px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .message:hover .message-actions { display: flex; }
        .message-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary-color); font-size: 0.9rem; }
        .message-content img, .message-content video { max-width: 150px; border-radius: 4px; margin-top: 8px; }
        .edit-area { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
        .edit-area textarea { background: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; width: 100%; font-family: inherit; font-size: 1rem; }
        .edit-controls button { padding: 4px 8px; border-radius: 4px; border: none; cursor: pointer; }
        .edit-controls .save { background: var(--primary-color); color: var(--bg-color); }
        
        /* --- Input Area --- */
        #chat-form-container { padding: 1rem; border-top: 1px solid var(--border-color); background-color: var(--surface-color); }
        #file-previews { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
        .preview-item { position: relative; width: 70px; height: 70px; flex-shrink: 0; }
        .preview-item img, .preview-item video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .preview-item .remove-file { position: absolute; top: -5px; right: -5px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; border: none; cursor: pointer; font-size: 14px; }
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; border-radius: 8px; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; }
        #input-area { display: flex; align-items: flex-end; background-color: #2a2a2a; border-radius: 12px; padding: 0.5rem; }
        #chat-input { flex-grow: 1; border: none; background: transparent; color: var(--text-color); font-size: 1rem; resize: none; max-height: 120px; overflow-y: auto; }
        #chat-input:focus { outline: none; }
        .input-btn { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; font-size: 1.5rem; padding: 0.5rem; border-radius: 8px; transition: background-color 0.2s; }
        .input-btn:hover { background-color: #3a3a3a; }
        #send-btn { color: var(--primary-color); }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (min-width: 768px) {
            #app-container { flex-direction: row; }
            #sidebar { width: 300px; height: 100vh; }
            #chat-container { height: 100vh; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <aside id="sidebar">
            <div class="sidebar-header">
                <button id="new-chat-btn">Ôºã New Chat</button>
            </div>
            <div id="history-list"></div>
        </aside>

        <main id="chat-container">
            <div class="chat-header">
                <span>AI Assistant</span>
                <button id="settings-toggle" title="Settings">‚öôÔ∏è</button>
                <div id="settings-panel">
                    <div class="theme-setting" style="margin-bottom: 1rem;">
                        <label>Theme</label>
                        <select id="theme-select">
                            <option value="default">Default</option>
                            <option value="cozy">Cozy</option>
                            <option value="techy">Techy</option>
                        </select>
                    </div>
                    <div class="theme-setting" style="margin-bottom: 1rem;">
                        <label>Mode</label>
                        <select id="mode-select">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1rem 0;">
                    <div class="settings-grid">
                        <!-- Controls are now hidden from UI as requested, but logic remains -->
                    </div>
                </div>
            </div>

            <div id="chat-messages"></div>
            
            <div id="chat-form-container">
                <div id="file-previews"></div>
                <form id="chat-form">
                    <div id="input-area">
                        <input type="file" id="file-input" multiple accept="image/*,video/*" hidden>
                        <button type="button" id="gallery-btn" class="input-btn" title="Upload from Gallery">üñºÔ∏è</button>
                        <button type="button" id="camera-btn" class="input-btn" title="Take a Photo">üì∑</button>
                        <textarea id="chat-input" placeholder="Message Assistant..." rows="1"></textarea>
                        <button type="submit" id="send-btn" class="input-btn" title="Send">‚û§</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        const API_KEY = "AIzaSyC4ZJKSp8ZmOJtRAxAoxC58MdF4K-8cHXQ"; // For local testing ONLY.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
        
        const dom = {
            chatMessages: document.getElementById('chat-messages'), chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('send-btn'),
            fileInput: document.getElementById('file-input'), galleryBtn: document.getElementById('gallery-btn'),
            cameraBtn: document.getElementById('camera-btn'), filePreviews: document.getElementById('file-previews'),
            settingsToggle: document.getElementById('settings-toggle'), settingsPanel: document.getElementById('settings-panel'),
            newChatBtn: document.getElementById('new-chat-btn'), historyList: document.getElementById('history-list'),
            themeSelect: document.getElementById('theme-select'), modeSelect: document.getElementById('mode-select'),
            root: document.documentElement
        };

        let currentChatHistory = [];
        let allChats = {};
        let activeChatId = null;
        let uploadedFiles = []; // { id, filename, mimeType, base64 }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initializeApp);
        dom.settingsToggle.addEventListener('click', toggleSettings);
        dom.chatForm.addEventListener('submit', handleSendMessage);
        dom.chatInput.addEventListener('input', () => autoGrowTextarea(dom.chatInput));
        dom.chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(e); } });
        dom.galleryBtn.addEventListener('click', () => { dom.fileInput.removeAttribute('capture'); dom.fileInput.click(); });
        dom.cameraBtn.addEventListener('click', () => { dom.fileInput.setAttribute('capture', 'environment'); dom.fileInput.click(); });
        dom.fileInput.addEventListener('change', handleFileSelection);
        dom.newChatBtn.addEventListener('click', startNewChat);
        dom.historyList.addEventListener('click', handleHistoryClick);
        dom.themeSelect.addEventListener('change', setTheme);
        dom.modeSelect.addEventListener('change', setTheme);
        document.addEventListener('click', (e) => {
            if (!dom.settingsPanel.contains(e.target) && !dom.settingsToggle.contains(e.target)) {
                dom.settingsPanel.classList.remove('settings-visible');
            }
        });

        // --- Initialization ---
        function initializeApp() {
            loadTheme();
            loadAllChats();
            if (!activeChatId) {
                startNewChat();
            }
        }
        
        // --- Core Functions ---
        function autoGrowTextarea(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }

        async function handleSendMessage(e, isRegeneration = false) {
            e.preventDefault();
            const userText = isRegeneration ? '' : dom.chatInput.value.trim();
            if (!isRegeneration && userText === "" && uploadedFiles.length === 0) return;
            
            if (!activeChatId) { startNewChat(false); }

            if (!isRegeneration) {
                const userMessage = { role: 'user', parts: [] };
                if (userText) userMessage.parts.push({ text: userText });
                uploadedFiles.forEach(file => {
                    userMessage.parts.push({ inline_data: { mime_type: file.mimeType, data: file.base64 } });
                });
                currentChatHistory.push(userMessage);
                renderChatMessages();
                dom.chatInput.value = '';
                autoGrowTextarea(dom.chatInput);
                dom.filePreviews.innerHTML = '';
                uploadedFiles = [];
                dom.fileInput.value = '';
            }

            const loadingMessage = displayMessage('loading', 'The assistant is thinking...');
            try {
                const modelResponse = await callAPI();
                loadingMessage.remove();
                
                const modelText = modelResponse.candidates[0].content.parts[0].text;
                currentChatHistory.push({ role: 'model', parts: [{ text: modelText }] });
                renderChatMessages();
                saveCurrentChat();
                updateHistorySidebar();

            } catch (error) {
                console.error("API Error:", error);
                loadingMessage.remove();
                displayMessage('error', `Error: ${error.message || 'Failed to get response.'}`);
            }
        }

        async function callAPI() {
            // These controls are now hardcoded as requested but can be modified here.
            const generationConfig = { temperature: 0.9, maxOutputTokens: 2048, topP: 1.0, topK: 1 };
            const requestBody = { contents: currentChatHistory, generationConfig };

            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message);
            }
            return response.json();
        }

        function displayMessage(role, text) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message', role);
            messageEl.innerHTML = `<div>${text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')}</div>`;
            dom.chatMessages.appendChild(messageEl);
            dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
            return messageEl;
        }

        function renderChatMessages() {
            dom.chatMessages.innerHTML = '';
            if (currentChatHistory.length === 0) {
                 dom.chatMessages.innerHTML = '<div class="message model">This is an empty chat. Start the conversation!</div>';
            }
            currentChatHistory.forEach((message, index) => {
                const text = message.parts.find(p => p.text)?.text || '';
                const filesData = message.parts.filter(p => p.inline_data).map(p => ({ mimeType: p.inline_data.mime_type, base64: p.inline_data.data }));
                
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.role}`;
                messageEl.dataset.index = index;

                let contentHTML = '<div class="message-content">';
                if (filesData.length > 0) {
                    filesData.forEach(file => {
                        if (file.mimeType.startsWith('image/')) {
                            contentHTML += `<img src="data:${file.mimeType};base64,${file.base64}">`;
                        } else if (file.mimeType.startsWith('video/')) {
                            contentHTML += `<video controls muted loop playsinline src="data:${file.mimeType};base64,${file.base64}"></video>`;
                        }
                    });
                }
                 if (text) contentHTML += `<div>${text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')}</div>`;
                contentHTML += '</div>';

                let actionsHTML = `<div class="message-actions">`;
                if(message.role === 'user') {
                    actionsHTML += `<button class="message-btn edit-btn" title="Edit">‚úèÔ∏è</button>`;
                }
                actionsHTML += `<button class="message-btn delete-btn" title="Delete">üóëÔ∏è</button></div>`;

                messageEl.innerHTML = contentHTML + actionsHTML;
                dom.chatMessages.appendChild(messageEl);
            });
            dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
        }
        
        // --- Message Actions (Edit/Delete) ---
        dom.chatMessages.addEventListener('click', (e) => {
            const messageEl = e.target.closest('.message');
            if (!messageEl) return;
            const index = parseInt(messageEl.dataset.index, 10);

            if (e.target.closest('.delete-btn')) {
                handleDeleteMessage(index);
            }
            if (e.target.closest('.edit-btn')) {
                handleEditMessage(messageEl, index);
            }
        });

        function handleDeleteMessage(index) {
            currentChatHistory.splice(index, (currentChatHistory[index].role === 'user' && currentChatHistory[index+1]?.role === 'model') ? 2 : 1);
            saveCurrentChat();
            renderChatMessages();
        }

        function handleEditMessage(messageEl, index) {
            const contentDiv = messageEl.querySelector('.message-content');
            const originalHTML = contentDiv.innerHTML;
            const originalText = currentChatHistory[index].parts.find(p => p.text)?.text || '';

            contentDiv.innerHTML = `
                <div class="edit-area">
                    <textarea rows="3">${originalText}</textarea>
                    <div class="edit-controls">
                        <button class="save">Save & Submit</button>
                        <button class="cancel">Cancel</button>
                    </div>
                </div>`;
            const textarea = contentDiv.querySelector('textarea');
            autoGrowTextarea(textarea);
            textarea.focus();

            contentDiv.querySelector('.cancel').addEventListener('click', () => { contentDiv.innerHTML = originalHTML; });
            contentDiv.querySelector('.save').addEventListener('click', async () => {
                const newText = textarea.value.trim();
                currentChatHistory = currentChatHistory.slice(0, index + 1); // Truncate history
                const textPart = currentChatHistory[index].parts.find(p => p.text);
                if (textPart) {
                    textPart.text = newText;
                } else {
                    currentChatHistory[index].parts.push({ text: newText });
                }
                renderChatMessages();
                await handleSendMessage({ preventDefault: () => {} }, true); // Regenerate response
            });
        }
        
        // --- File Handling ---
        function handleFileSelection(e) { /* ... (same as before, omitted for brevity but included in final code) ... */ }

        // --- History Management ---
        function startNewChat(render = true) { /* ... (same as before) ... */ }
        function saveCurrentChat() { /* ... (same as before) ... */ }
        function saveAllChats() { localStorage.setItem('ai-chat-history', JSON.stringify(allChats)); }
        function loadAllChats() { /* ... (modified to use new key) ... */ }
        function updateHistorySidebar() {
            dom.historyList.innerHTML = '';
            const sortedChats = Object.values(allChats).sort((a,b) => b.timestamp - a.timestamp);

            sortedChats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.dataset.id = chat.id;
                
                const firstUserMsg = chat.history.find(msg => msg.role === 'user');
                const previewText = firstUserMsg?.parts.find(p => p.text)?.text || "New Chat";
                
                item.innerHTML = `<span class="history-title">${previewText}</span><button class="delete-chat-btn" title="Delete Chat">√ó</button>`;
                if (chat.id === activeChatId) item.classList.add('active');
                dom.historyList.appendChild(item);
            });
        }
        function handleHistoryClick(e) {
            const id = e.target.closest('.history-item')?.dataset.id;
            if (e.target.closest('.delete-chat-btn')) {
                deleteChat(id);
            } else if (id) {
                loadChat(id);
            }
        }
        function deleteChat(chatId) {
            if (!chatId || !confirm("Are you sure you want to delete this chat?")) return;
            delete allChats[chatId];
            saveAllChats();
            if (activeChatId === chatId) {
                startNewChat();
            }
            updateHistorySidebar();
        }
        function loadChat(chatId) {
            if (!allChats[chatId]) return;
            activeChatId = chatId;
            currentChatHistory = allChats[chatId].history;
            renderChatMessages();
            updateHistorySidebar();
        }

        // --- UI & Theme ---
        function toggleSettings() { dom.settingsPanel.classList.toggle('settings-visible'); }
        function setTheme() {
            const theme = dom.themeSelect.value;
            const mode = dom.modeSelect.value;
            dom.root.dataset.theme = theme;
            dom.root.dataset.mode = mode;
            localStorage.setItem('ai-chat-theme', theme);
            localStorage.setItem('ai-chat-mode', mode);
        }
        function loadTheme() {
            const theme = localStorage.getItem('ai-chat-theme') || 'default';
            const mode = localStorage.getItem('ai-chat-mode') || 'dark';
            dom.themeSelect.value = theme;
            dom.modeSelect.value = mode;
            setTheme();
        }

        // Re-adding the full functions that were shortened with comments
        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            if (uploadedFiles.length + files.length > 10) {
                alert("You can upload a maximum of 10 files."); return;
            }
            files.forEach(file => {
                const reader = new FileReader();
                const fileId = Date.now() + Math.random();
                const previewEl = document.createElement('div');
                previewEl.className = 'preview-item';
                previewEl.innerHTML = `<div class="loading-overlay"><div class="spinner"></div></div><button class="remove-file" data-id="${fileId}">&times;</button>`;
                dom.filePreviews.appendChild(previewEl);
                previewEl.querySelector('.remove-file').addEventListener('click', () => { uploadedFiles = uploadedFiles.filter(f => f.id !== fileId); previewEl.remove(); });
                reader.onload = (event) => {
                    const base64String = event.target.result.split(',')[1];
                    uploadedFiles.push({ id: fileId, filename: file.name, mimeType: file.type, base64: base64String });
                    let mediaPreview;
                    if (file.type.startsWith('image/')) { mediaPreview = document.createElement('img'); } 
                    else { mediaPreview = document.createElement('video'); mediaPreview.muted = true; mediaPreview.playsinline = true; mediaPreview.autoplay = true; mediaPreview.loop = true; }
                    mediaPreview.src = event.target.result;
                    previewEl.querySelector('.loading-overlay').remove();
                    previewEl.prepend(mediaPreview);
                };
                reader.onerror = (error) => { console.error("File reading error:", error); previewEl.remove(); alert(`Error reading file: ${file.name}`); };
                reader.readAsDataURL(file);
            });
        }
        function startNewChat(render = true) {
            activeChatId = `chat_${Date.now()}`;
            currentChatHistory = [];
            allChats[activeChatId] = { id: activeChatId, history: [], timestamp: Date.now() };
            renderChatMessages();
            saveAllChats();
            if (render) updateHistorySidebar();
        }
        function saveCurrentChat() { if (!activeChatId) return; allChats[activeChatId].history = currentChatHistory; allChats[activeChatId].timestamp = Date.now(); saveAllChats(); }
        function loadAllChats() {
            const storedChats = localStorage.getItem('ai-chat-history');
            if (storedChats) { allChats = JSON.parse(storedChats); }
            updateHistorySidebar();
            const sortedChats = Object.values(allChats).sort((a,b) => b.timestamp - a.timestamp);
            if (sortedChats.length > 0) { loadChat(sortedChats[0].id); }
        }
    </script>
</body>
</html>